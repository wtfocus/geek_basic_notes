[toc]

## 45 | 位图：如何实现网页爬虫中的URL去重功能？

1. 开篇题
	- 如何实现网页爬虫中的URL去重功能？

### 算法解析

1. 需求
	1. 功能性需求
		- 添加一个 URL 
		- 查询一个 URL
	2. 非功能性需求
		- 执行效率要尽可能高

#### 位图（BitMap)

1. 简化版需求

	- 我们有 1 千万个整数，整数的范围在 1 到 1 亿之间。如何快速查找某个整数是否在这 1 千万个整数中呢？

2. 思路

	- 我们申请一个大小为 1 亿、数据类型为布尔类型（true 或者 false）的数组。
	- 我们将这 1 千万个整数作为数组下标，将对应的数组值设置成 true。
	- 比如，整数 5 对应下标为 5 的数组值设置为 true，也就是 array[5]=true。

3. 优化思路

	- 很多语言中提供的布尔类型，大小是 1 个字节的，并不能节省太多内存空间。
	- 我们可以用一个二进制位（bit）表示 true 和 false 两个值就可以了。
	- 那如何通过编程语言，来表示一个二进制位呢？

4. 代码实现

	- ```java
		
		public class BitMap { // Java中char类型占16bit，也即是2个字节
		  private char[] bytes;
		  private int nbits;
		  
		  public BitMap(int nbits) {
		    this.nbits = nbits;
		    this.bytes = new char[nbits/16+1];
		  }
		
		  public void set(int k) {
		    if (k > nbits) return;
		    int byteIndex = k / 16;
		    int bitIndex = k % 16;
		    bytes[byteIndex] |= (1 << bitIndex);
		  }
		
		  public boolean get(int k) {
		    if (k > nbits) return false;
		    int byteIndex = k / 16;
		    int bitIndex = k % 16;
		    return (bytes[byteIndex] & (1 << bitIndex)) != 0;
		  }
		}
		```

5. 分析

	- 如果用散列表存储这 1 千万的数据，数据是 32 位的整型数，也就是需要 4 个字节的存储空间，那总共至少需要 40MB 的存储空间。
	- 如果我们通过位图的话，数字范围在 1 到 1 亿之间，只需要 1 亿个二进制位，也就是 12MB 左右的存储空间。

#### 布隆过滤器

1. 思路
	- 我们仍然使用一个 1 亿个二进制大小的位图，然后通过哈希函数，对数字进行处理，让它落在这 1 到 1 亿范围内。
	- 比如我们把哈希函数设计成 f(x)=x%n。其中，x 表示数字，n 表示位图的大小（1 亿），也就是，对数字跟位图的大小进行取模求余。
2. 问题
	- 取模求余的哈希函数，会存在哈希冲突。
	- 如何降低冲突的概率呢？
3. 优化思路
	- 使用 K 个哈希函数，对同一个数字求哈希值，那会得到 K 个不同的哈希值，我们用　K 个二进制位，来表示一个数字的存在。
	- 如果 K 个哈希值都为 true，则说明这个数字存在。如果其中任意一个不为 true，那就说明这个数字不存在。
4. 问题：误判
	- 如果某个数字经过布隆过滤器判断**不存在**，那说明这个数字真的不存在，**不会发生误判**。
	- 如果某个数字经过布隆过滤器判断**存在**，这个时候才会**有可能误判**，有可能并不存在。
5. 优化：如何将误判的概率降到非常低
	- 可以调整哈希函数的**个数**、位图的大小跟存储数字的个数间的**比例**。
6. 适用场景
	- 对误判有一定的容忍度的场景，不需要 100％正确。

